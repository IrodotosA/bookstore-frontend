<div class="checkout-page">

  <div class="checkout-hero">
    <div class="checkout-hero-content">
      <h1>Checkout</h1>
    </div>
  </div>

  <div class="checkout-container">

    <!-- LEFT SIDE FORM -->
    <form class="checkout-form" [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">

      <h2>Billing Details</h2>

      <div class="form-grid" formGroupName="customer">

        <!-- NAME -->
        <div>
          <label>Name</label>
          <input pInputText formControlName="name" />
          @if (customer.get('name')?.hasError('required') && (customer.get('name')?.dirty || customer.get('name')?.touched)) {
            <p-message severity="error" text="Name is required"></p-message>
          }
        </div>

        <!-- EMAIL -->
        <div>
          <label>Email</label>
          <input pInputText type="email" formControlName="email" />

          @if (customer.get('email')?.hasError('required') && (customer.get('email')?.dirty || customer.get('email')?.touched)) {
            <p-message severity="error" text="Email is required"></p-message>
          }

          @if (customer.get('email')?.hasError('email') && (customer.get('email')?.dirty || customer.get('email')?.touched)) {
            <p-message severity="error" text="Invalid email format"></p-message>
          }
        </div>

        <!-- PHONE -->
        <div>
          <label>Phone</label>
          <input pInputText formControlName="phone" />

          @if (customer.get('phone')?.invalid && (customer.get('phone')?.dirty || customer.get('phone')?.touched)) {
            <p-message severity="error" text="Only numbers and + allowed"></p-message>
          }
        </div>

        <!-- ADDRESS -->
        <div>
          <label>Address</label>
          <input pInputText formControlName="address" />

          @if (customer.get('address')?.hasError('required') && (customer.get('address')?.dirty || customer.get('address')?.touched)) {
            <p-message severity="error" text="Address is required"></p-message>
          }
        </div>

        <!-- CITY -->
        <div>
          <label>City</label>
          <input pInputText formControlName="city" />

          @if (customer.get('city')?.hasError('required') && (customer.get('city')?.dirty || customer.get('city')?.touched)) {
            <p-message severity="error" text="City is required"></p-message>
          }
        </div>

        <!-- POSTAL CODE -->
        <div>
          <label>Postal Code</label>
          <input pInputText formControlName="postalCode" />

          @if (customer.get('postalCode')?.invalid && (customer.get('postalCode')?.dirty || customer.get('postalCode')?.touched)) {
            <p-message severity="error" text="Postal code must contain only numbers"></p-message>
          }
        </div>

        <!-- COUNTRY -->
        <div>
          <label>Country</label>
          <input pInputText formControlName="country" />

          @if (customer.get('country')?.hasError('required') && (customer.get('country')?.dirty || customer.get('country')?.touched)) {
            <p-message severity="error" text="Country is required"></p-message>
          }
        </div>

      </div>

      <h2>Payment Method</h2>

      <div class="payment-methods">
        <label class="method-option">
          <input type="radio" formControlName="paymentMethod" value="card" />
          Credit / Debit Card
        </label>

        <label class="method-option">
          <input type="radio" formControlName="paymentMethod" value="cod" />
          Cash on Delivery
        </label>

        <label class="method-option">
          <input type="radio" formControlName="paymentMethod" value="paypal" />
          PayPal (Coming Soon)
        </label>
      </div>

      <!-- CARD FORM -->
      @if (checkoutForm.get('paymentMethod')?.value === 'card') {
        <div class="card-form" formGroupName="card">

          <h3>Card Details</h3>

          <div class="form-grid">

            <!-- CARD NUMBER -->
            <div>
              <label>Card Number</label>
              <input pInputText formControlName="number" />

              @if (checkoutForm.hasError('cardIncomplete') && (card.get('number')?.dirty || card.get('number')?.touched)) {
                <p-message severity="error" text="Card number is required"></p-message>
              }
            </div>

            <!-- NAME -->
            <div>
              <label>Name on Card</label>
              <input pInputText formControlName="name" />

              @if (checkoutForm.hasError('cardIncomplete') && (card.get('name')?.dirty || card.get('name')?.touched)) {
                <p-message severity="error" text="Card name is required"></p-message>
              }
            </div>

            <!-- EXP -->
            <div>
              <label>Expiration (MM/YY)</label>
              <input pInputText formControlName="exp" />

              @if (checkoutForm.hasError('cardIncomplete') && (card.get('exp')?.dirty || card.get('exp')?.touched)) {
                <p-message severity="error" text="Expiration is required"></p-message>
              }

              @if (checkoutForm.hasError('invalidExpFormat') && (card.get('exp')?.dirty || card.get('exp')?.touched)) {
                <p-message severity="error" text="Invalid format (MM/YY)"></p-message>
              }
            </div>

            <!-- CVV -->
            <div>
              <label>CVV</label>
              <input pInputText formControlName="cvv" />

              @if (checkoutForm.hasError('cardIncomplete') && (card.get('cvv')?.dirty || card.get('cvv')?.touched)) {
                <p-message severity="error" text="CVV is required"></p-message>
              }
            </div>

          </div>

          @if (checkoutForm.hasError('invalidCard')) {
            <p-message 
              severity="error"
              text="Card is invalid. Use one of the test cards below.">
            </p-message>
          }

          <div class="test-card-box">
            <h4>Test Cards</h4>
            <ul>
              @for (t of testCards; track t.number) {
                <li>
                  <strong>{{ t.type }}:</strong>
                  {{ t.number }} — Exp: {{ t.exp }} — CVV: {{ t.cvv }}
                </li>
              }
            </ul>
          </div>

        </div>
      }

      <button 
        pButton 
        class="w-full mt-3" 
        label="Place Order" 
        type="submit"
        [disabled]="checkoutForm.invalid">
      </button>

    </form>

    <!-- SUMMARY -->
    <div class="checkout-summary">
      <h2>Your Order</h2>

      <div class="summary-list">
        @for (item of items; track item._id) {
          <div class="summary-item">
            <span>{{ item.title }} (x{{ item.quantity }})</span>
            <span>€{{ item.price * item.quantity | number:'1.2-2' }}</span>
          </div>
        }
      </div>

      <hr />

      <div class="summary-total">
        <span>Total:</span>
        <span>€{{ total | number:'1.2-2' }}</span>
      </div>

    </div>

  </div>
</div>
